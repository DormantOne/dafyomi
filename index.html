const dafYomiJsonUrl = "Daf_Yomi_Cycle.json"; // Path to your JSON file
let hebrewTextContent = "";
const aiPrompt = "Provide context, summarize, and translate key phrases for the following Daf: ";

// Get today's date in YYYY-MM-DD format
const today = new Date().toISOString().split('T')[0];

document.getElementById("fetchDaf").addEventListener("click", async () => {
    const currentDateDiv = document.getElementById("currentDate");
    const currentDafDiv = document.getElementById("currentDaf");
    const hebrewTextDiv = document.getElementById("hebrewText");
    const promptRecapDiv = document.getElementById("promptRecap");

    hebrewTextDiv.textContent = "Fetching Daf..."; // Loading indicator

    try {
        // Fetch the Daf Yomi JSON file
        const response = await fetch(dafYomiJsonUrl);
        if (!response.ok) {
            throw new Error(`Failed to load Daf Yomi JSON: ${response.status}`);
        }
        const dafYomiData = await response.json();
        const currentDaf = dafYomiData[today];

        if (!currentDaf) {
            currentDateDiv.textContent = `Today's Date: ${today}`;
            currentDafDiv.textContent = "No Daf Yomi assigned for today.";
            hebrewTextDiv.textContent = "No content available for today's Daf.";
            return;
        }

        currentDateDiv.textContent = `Today's Date: ${today}`;
        currentDafDiv.textContent = `Daf Yomi: ${currentDaf}`;

        // Fetch the text for the current Daf using the standard Sefaria API
        const url = `https://www.sefaria.org/api/texts/${currentDaf}?context=0&pad=0`;
        const dafResponse = await fetch(url, {
            headers: { "Accept": "application/json" }
        });

        if (!dafResponse.ok) {
            throw new Error(`Failed to load Daf text: ${dafResponse.status} ${dafResponse.statusText}`);
        }

        // Log the raw response text for debugging
        const rawText = await dafResponse.text();
        console.log("Raw API Response:", rawText);

        // Attempt to parse the JSON
        let dafData;
        try {
            dafData = JSON.parse(rawText);
        } catch (jsonError) {
            console.error("JSON Parsing Error:", jsonError);
            throw new Error(`Invalid JSON response from Sefaria API: ${jsonError.message}`);
        }

        // Use the 'he' field for Hebrew text
        const hebrewText = dafData.he || "No Hebrew text found.";
        hebrewTextContent = Array.isArray(hebrewText) ? hebrewText.join("\n") : hebrewText;

        hebrewTextDiv.innerHTML = Array.isArray(hebrewText) ? hebrewText.join("<br>") : hebrewText;

        // Display prompt recap with the beginning of the Daf
        const shortenedText = hebrewTextContent.split("\n").slice(0, 3).join(" ") + "...";
        promptRecapDiv.textContent = `${aiPrompt} ${shortenedText}`;

    } catch (error) {
        console.error("Error fetching Daf:", error);
        hebrewTextDiv.textContent = `Error: ${error.message}. Please check your network or try again later.`;
    }
});

document.getElementById("copyDaf").addEventListener("click", () => {
    const promptRecapDiv = document.getElementById("promptRecap");
    const fullTextToCopy = `${promptRecapDiv.textContent}\n\n${hebrewTextContent}`;

    if (hebrewTextContent) {
        navigator.clipboard.writeText(fullTextToCopy)
            .then(() => alert("Prompt and Daf Yomi content copied to clipboard!"))
            .catch(() => alert("Failed to copy content."));
    } else {
        alert("No content to copy!");
    }
});
